# CD-103: Implement InvitationService with CRUD Operations

**Epic**: Community Directory
**Sprint**: 1
**Story Points**: 5
**Priority**: P0 (Blocker)
**Status**: ‚¨ú Not Started
**Assignee**: Unassigned
**Dependencies**: CD-101, CD-102

---

## üìã Description

Build the InvitationService class as an ElizaOS Service with complete CRUD operations for invitation management. This service handles invitation creation, code generation, expiration logic, and status tracking.

**Key Goals**:
- Implement secure invitation code generation
- Handle invitation lifecycle (create, accept, cancel, expire)
- Integrate with Drizzle ORM for database operations
- Provide clean API for Actions and Routes to use

---

## üéØ Acceptance Criteria

- [ ] InvitationService extends ElizaOS Service correctly
- [ ] `createInvitation()` generates unique 16-character codes
- [ ] `getInvitationByCode()` checks expiration automatically
- [ ] `acceptInvitation()` validates status before accepting
- [ ] `cancelInvitation()` updates status to cancelled
- [ ] `listInvitations()` supports filtering by creator and status
- [ ] All methods handle errors gracefully with clear messages
- [ ] Unit tests achieve >80% coverage
- [ ] Service registered in plugin and starts successfully

---

## üìê Technical Approach

### Data Access Strategy
- **ElizaOS Memory**: Relationship tracking (inviter/invitee) will be handled in CD-201
- **Drizzle/PostgreSQL**: All invitation CRUD operations, status tracking, expiry logic

### Architecture Notes
**Service Pattern** (from ARCHITECTURE_RECOMMENDATION.md):
- Extends ElizaOS Service base class
- Registered in plugin services array
- Accessible via `runtime.getService('invitation-service')`
- Uses Drizzle ORM for type-safe database queries

**Invitation Code Security**:
- 16-character alphanumeric codes
- Generated using UUID v4, stripped and truncated
- Unique constraint enforced at database level
- No sequential or predictable patterns

**Expiration Logic**:
- 3-day expiration from creation time
- Automatic expiration check on retrieval
- Background job will handle bulk expiration (CD-106)

---

## ‚úÖ Tasks

- [ ] Create `InvitationService` class extending ElizaOS Service
- [ ] Implement `createInvitation(createdBy, telegramUsername?)` method
- [ ] Implement invitation code generator using UUID v4
- [ ] Implement `getInvitationByCode(code)` method with expiration check
- [ ] Implement `listInvitations(createdBy?, status?)` method with filtering
- [ ] Implement `acceptInvitation(code, acceptedBy)` method with validation
- [ ] Implement `cancelInvitation(invitationId)` method
- [ ] Add private `updateInvitationStatus(id, status)` helper method
- [ ] Implement `static start()` method for service initialization
- [ ] Add comprehensive error handling for all methods
- [ ] Write unit tests for all CRUD operations
- [ ] Write unit tests for expiration logic
- [ ] Write unit tests for validation failures
- [ ] Register service in plugin services array

---

## üìÅ Files to Create/Modify

- `src/plugins/communityDirectory/services/InvitationService.ts` - Main service class
- `src/plugins/communityDirectory/__tests__/invitationService.test.ts` - Unit tests
- `src/plugins/communityDirectory/__tests__/utils/mockRuntime.ts` - Test utilities
- `src/plugins/communityDirectory/index.ts` - Register service (modify)

---

## üß™ Testing Requirements

### Unit Tests
- [ ] Test invitation code generation (16 chars, unique)
- [ ] Test expiration date calculation (3 days)
- [ ] Test status defaults to pending
- [ ] Test optional telegram username storage
- [ ] Test retrieval by valid code
- [ ] Test null return for invalid code
- [ ] Test automatic expiration marking
- [ ] Test filtering by creator and status
- [ ] Test ordering by created_at descending
- [ ] Test accept updates status and records acceptor
- [ ] Test accept throws for non-existent invitation
- [ ] Test accept throws for expired invitation
- [ ] Test accept throws for already accepted invitation
- [ ] Test cancel updates status

### Integration Tests
- [ ] Service initializes with runtime
- [ ] Service accessible via `runtime.getService('invitation-service')`
- [ ] All database operations complete successfully
- [ ] Foreign key constraints work with community_members table

---

## üîó Related Documentation

- [EPIC_1_IMPLEMENTATION_PLAN.md](../../../docs/specs/EPIC_1_IMPLEMENTATION_PLAN.md) - Lines 208-381 (Story 1.3)
- [ARCHITECTURE_RECOMMENDATION.md](../../../docs/specs/ARCHITECTURE_RECOMMENDATION.md) - Lines 338-411 (Service Implementation Example)
- [ElizaOS Service Pattern](https://elizaos.github.io/eliza/docs/core/services/)

---

## üìù Implementation Notes

### Service Implementation Example

```typescript
// services/InvitationService.ts
import { Service, IAgentRuntime } from '@elizaos/core';
import { v4 as uuidv4 } from 'uuid';
import { db } from '../database/client';
import { communityInvitations } from '../database/schema';
import { Invitation, InvitationStatus } from '../types';
import { eq, and } from 'drizzle-orm';

export class InvitationService extends Service {
  static serviceType = 'invitation-service';

  async createInvitation(
    createdBy: string,
    invitedTelegramUsername?: string
  ): Promise<Invitation> {
    const invitationCode = uuidv4().replace(/-/g, '').substring(0, 16);
    const expiresAt = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000);

    const [invitation] = await db
      .insert(communityInvitations)
      .values({
        invitation_code: invitationCode,
        created_by: createdBy,
        invited_telegram_username: invitedTelegramUsername,
        status: InvitationStatus.PENDING,
        expires_at: expiresAt,
      })
      .returning();

    return invitation;
  }

  async getInvitationByCode(code: string): Promise<Invitation | null> {
    const [invitation] = await db
      .select()
      .from(communityInvitations)
      .where(eq(communityInvitations.invitation_code, code))
      .limit(1);

    if (!invitation) return null;

    // Check expiration
    if (
      new Date(invitation.expires_at) < new Date() &&
      invitation.status === InvitationStatus.PENDING
    ) {
      await this.updateInvitationStatus(
        invitation.invitation_id,
        InvitationStatus.EXPIRED
      );
      return { ...invitation, status: InvitationStatus.EXPIRED };
    }

    return invitation;
  }

  async listInvitations(
    createdBy?: string,
    status?: InvitationStatus
  ): Promise<Invitation[]> {
    const conditions = [];
    if (createdBy) conditions.push(eq(communityInvitations.created_by, createdBy));
    if (status) conditions.push(eq(communityInvitations.status, status));

    return db
      .select()
      .from(communityInvitations)
      .where(conditions.length > 0 ? and(...conditions) : undefined)
      .orderBy(communityInvitations.created_at, 'desc');
  }

  async acceptInvitation(code: string, acceptedBy: string): Promise<void> {
    const invitation = await this.getInvitationByCode(code);
    if (!invitation) throw new Error('Invitation not found');
    if (invitation.status !== InvitationStatus.PENDING) {
      throw new Error(`Invitation is ${invitation.status}`);
    }

    await db
      .update(communityInvitations)
      .set({
        status: InvitationStatus.ACCEPTED,
        accepted_by: acceptedBy,
        accepted_at: new Date(),
        updated_at: new Date(),
      })
      .where(eq(communityInvitations.invitation_id, invitation.invitation_id));
  }

  async cancelInvitation(invitationId: string): Promise<void> {
    await this.updateInvitationStatus(invitationId, InvitationStatus.CANCELLED);
  }

  private async updateInvitationStatus(
    invitationId: string,
    status: InvitationStatus
  ): Promise<void> {
    await db
      .update(communityInvitations)
      .set({ status, updated_at: new Date() })
      .where(eq(communityInvitations.invitation_id, invitationId));
  }

  static async start(runtime: IAgentRuntime): Promise<InvitationService> {
    return new InvitationService(runtime);
  }
}
```

---

## ‚úÖ Definition of Done

- [ ] InvitationService class implements all CRUD methods
- [ ] Invitation codes are unique and secure (16 characters)
- [ ] Expiration logic works correctly
- [ ] Status validation prevents invalid transitions
- [ ] Error handling provides clear, actionable messages
- [ ] Unit tests achieve >80% coverage
- [ ] All tests passing
- [ ] Service registered in plugin
- [ ] Code reviewed and approved
- [ ] No TypeScript compilation errors

---

**Created**: 2024-12-05
**Last Updated**: 2024-12-05
**Estimated Completion**: Day 3 of Sprint 1
