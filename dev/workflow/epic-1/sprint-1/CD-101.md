# CD-101: Create Database Migrations

**Epic**: Community Directory
**Sprint**: 1
**Story Points**: 5
**Priority**: P0 (Blocker)
**Status**: =2 Not Started
**Assignee**: Unassigned
**Dependencies**: None

---

## =Ë Description

Create PostgreSQL migrations for all community directory tables using Drizzle ORM. This establishes the database foundation for member profiles, invitations, relationships, and participation tracking.

**Key Goals**:
- Define schema for all 5 core tables
- Set up proper indexes for query performance
- Establish foreign key relationships and constraints
- Create both up and down migrations for reversibility

---

## <¯ Acceptance Criteria

- [ ] `community_invitations` table created with all fields and indexes
- [ ] `community_members` table created with GitHub verification fields
- [ ] `member_relationships` table created with JSONB for ElizaOS Memory integration
- [ ] `member_participation` table created for engagement tracking
- [ ] `member_daily_highlights` table created (placeholder for future)
- [ ] Foreign key constraints enforce referential integrity
- [ ] Indexes created on frequently queried columns (telegram_id, github_username, status)
- [ ] Migration runs successfully on clean database
- [ ] Rollback migration restores previous state
- [ ] TypeScript schema types generated from migrations

---

## =Ð Technical Approach

### Data Access Strategy
- **ElizaOS Memory**: NOT used for this ticket (structure only, data population in later tickets)
- **Drizzle/PostgreSQL**: PRIMARY storage for all business data (member profiles, invitations, reputation scores)

### Architecture Notes
**Hybrid Data Strategy** (from ARCHITECTURE_RECOMMENDATION.md):
- Drizzle handles structured business data (profiles, invitations, scores)
- ElizaOS Memory will handle conversational data (implemented in CD-201+)
- This ticket establishes the Drizzle foundation

**Schema Design Principles**:
- JSONB fields for flexible data (github_profile_data, profile_data)
- Explicit status enums for state management
- Timestamp tracking (created_at, updated_at, deleted_at)
- Soft delete support for audit trails

---

##  Tasks

- [ ] Install Drizzle ORM and PostgreSQL driver (`drizzle-orm`, `pg`)
- [ ] Create `src/plugins/communityDirectory/database/schema.ts` with table definitions
- [ ] Define `community_invitations` table schema
- [ ] Define `community_members` table schema with GitHub fields
- [ ] Define `member_relationships` table schema (JSONB for ElizaOS integration)
- [ ] Define `member_participation` table schema
- [ ] Define `member_daily_highlights` table placeholder
- [ ] Add indexes: telegram_id, github_username, invitation_code, status fields
- [ ] Add foreign key constraints (invited_by, created_by references)
- [ ] Create migration file using Drizzle kit (`drizzle-kit generate`)
- [ ] Create rollback migration
- [ ] Test migration on local PostgreSQL
- [ ] Test rollback migration
- [ ] Document schema design decisions in README

---

## =Á Files to Create/Modify

- `src/plugins/communityDirectory/database/schema.ts` - Drizzle table definitions
- `src/plugins/communityDirectory/database/client.ts` - PostgreSQL connection pool
- `drizzle/migrations/0001_create_community_tables.sql` - Generated migration
- `drizzle/migrations/0001_create_community_tables_down.sql` - Rollback migration
- `src/plugins/communityDirectory/database/README.md` - Schema documentation
- `package.json` - Add drizzle-orm, drizzle-kit, pg dependencies
- `drizzle.config.ts` - Drizzle configuration file

---

## >ê Testing Requirements

### Unit Tests
- [ ] Test database client initialization
- [ ] Test connection pool configuration
- [ ] Test schema type exports

### Integration Tests
- [ ] Run migration on clean database instance
- [ ] Verify all tables created successfully
- [ ] Verify indexes exist using `EXPLAIN` queries
- [ ] Insert test data into each table
- [ ] Test foreign key constraints (should reject invalid references)
- [ ] Run rollback migration
- [ ] Verify all tables dropped successfully
- [ ] Re-run migration (idempotency test)

### Manual Testing
```bash
# Apply migrations
bun run db:migrate

# Verify schema
psql $POSTGRES_URL -c "\d community_invitations"
psql $POSTGRES_URL -c "\d community_members"
psql $POSTGRES_URL -c "\d member_relationships"
psql $POSTGRES_URL -c "\d member_participation"

# Check indexes
psql $POSTGRES_URL -c "\di"

# Test rollback
bun run db:rollback

# Re-apply
bun run db:migrate
```

---

## = Related Documentation

- [EPIC_1_IMPLEMENTATION_PLAN.md](../../../docs/specs/EPIC_1_IMPLEMENTATION_PLAN.md) - Lines 59-96 (Story 1.1)
- [ARCHITECTURE_RECOMMENDATION.md](../../../docs/specs/ARCHITECTURE_RECOMMENDATION.md) - Lines 158-281 (Hybrid Data Strategy)
- [Drizzle ORM Migrations](https://orm.drizzle.team/docs/migrations)
- [PostgreSQL Indexing Best Practices](https://www.postgresql.org/docs/current/indexes.html)

---

## =Ý Implementation Notes

### Schema Design

**community_invitations**:
```typescript
export const communityInvitations = pgTable('community_invitations', {
  invitation_id: uuid('invitation_id').primaryKey().defaultRandom(),
  invitation_code: varchar('invitation_code', { length: 16 }).unique().notNull(),
  created_by: varchar('created_by', { length: 20 }).notNull(), // member_id
  invited_telegram_username: varchar('invited_telegram_username', { length: 255 }),
  status: varchar('status', { length: 20 }).default('pending').notNull(),
  expires_at: timestamp('expires_at').notNull(),
  accepted_by: varchar('accepted_by', { length: 20 }), // member_id
  accepted_at: timestamp('accepted_at'),
  created_at: timestamp('created_at').defaultNow().notNull(),
  updated_at: timestamp('updated_at').defaultNow().notNull(),
}, (table) => ({
  codeIdx: index('invitation_code_idx').on(table.invitation_code),
  statusIdx: index('invitation_status_idx').on(table.status),
  createdByIdx: index('invitation_created_by_idx').on(table.created_by),
}));
```

**community_members**:
```typescript
export const communityMembers = pgTable('community_members', {
  id: uuid('id').primaryKey().defaultRandom(),
  member_id: varchar('member_id', { length: 20 }).unique().notNull(), // #247
  telegram_id: varchar('telegram_id', { length: 255 }).unique().notNull(),
  telegram_username: varchar('telegram_username', { length: 255 }),
  name: varchar('name', { length: 255 }).notNull(),
  primary_role: varchar('primary_role', { length: 50 }).notNull(),
  organization: varchar('organization', { length: 255 }),
  country: varchar('country', { length: 100 }),

  // GitHub fields
  github_username: varchar('github_username', { length: 255 }),
  github_verified: boolean('github_verified').default(false).notNull(),
  github_verified_at: timestamp('github_verified_at'),
  github_profile_data: jsonb('github_profile_data'), // Flexible GitHub data storage

  // Status and reputation
  status: varchar('status', { length: 20 }).default('not_member').notNull(),
  reputation_score: integer('reputation_score').default(0).notNull(),
  reputation_tier: varchar('reputation_tier', { length: 50 }).default('Novice'),

  // Invitation tracking
  invited_by: varchar('invited_by', { length: 20 }), // member_id
  registration_fee_paid: boolean('registration_fee_paid').default(false),
  registration_fee_tx_hash: varchar('registration_fee_tx_hash', { length: 255 }),

  // Additional profile data
  profile_data: jsonb('profile_data'),

  // Timestamps
  created_at: timestamp('created_at').defaultNow().notNull(),
  updated_at: timestamp('updated_at').defaultNow().notNull(),
  last_active_at: timestamp('last_active_at'),
  deleted_at: timestamp('deleted_at'), // Soft delete
}, (table) => ({
  telegramIdIdx: index('member_telegram_id_idx').on(table.telegram_id),
  githubUsernameIdx: index('member_github_username_idx').on(table.github_username),
  statusIdx: index('member_status_idx').on(table.status),
  reputationScoreIdx: index('member_reputation_score_idx').on(table.reputation_score),
}));
```

**member_relationships**:
```typescript
export const memberRelationships = pgTable('member_relationships', {
  id: uuid('id').primaryKey().defaultRandom(),
  entity_id_a: varchar('entity_id_a', { length: 255 }).notNull(), // ElizaOS entity ID
  entity_id_b: varchar('entity_id_b', { length: 255 }).notNull(), // ElizaOS entity ID
  relationship_type: varchar('relationship_type', { length: 50 }).notNull(), // INVITED, MENTORED, etc.
  content: jsonb('content').notNull(), // Flexible relationship metadata
  created_at: timestamp('created_at').defaultNow().notNull(),
}, (table) => ({
  entityAIdx: index('relationship_entity_a_idx').on(table.entity_id_a),
  entityBIdx: index('relationship_entity_b_idx').on(table.entity_id_b),
  typeIdx: index('relationship_type_idx').on(table.relationship_type),
}));
```

**member_participation**:
```typescript
export const memberParticipation = pgTable('member_participation', {
  id: uuid('id').primaryKey().defaultRandom(),
  member_id: varchar('member_id', { length: 20 }).notNull(),
  event_type: varchar('event_type', { length: 50 }).notNull(), // MESSAGE, REACTION, VOICE, etc.
  platform: varchar('platform', { length: 50 }).notNull(), // telegram, discord
  room_id: varchar('room_id', { length: 255 }).notNull(),
  event_metadata: jsonb('event_metadata'),
  occurred_at: timestamp('occurred_at').defaultNow().notNull(),
}, (table) => ({
  memberIdIdx: index('participation_member_id_idx').on(table.member_id),
  eventTypeIdx: index('participation_event_type_idx').on(table.event_type),
  occurredAtIdx: index('participation_occurred_at_idx').on(table.occurred_at),
}));
```

**member_daily_highlights**:
```typescript
export const memberDailyHighlights = pgTable('member_daily_highlights', {
  id: uuid('id').primaryKey().defaultRandom(),
  member_id: varchar('member_id', { length: 20 }).notNull(),
  highlight_date: date('highlight_date').notNull(),
  message_count: integer('message_count').default(0),
  reaction_count: integer('reaction_count').default(0),
  voice_minutes: integer('voice_minutes').default(0),
  reputation_earned: integer('reputation_earned').default(0),
  created_at: timestamp('created_at').defaultNow().notNull(),
}, (table) => ({
  memberDateIdx: index('highlight_member_date_idx').on(table.member_id, table.highlight_date),
}));
```

### Migration Commands

```bash
# Generate migration from schema
bunx drizzle-kit generate

# Apply migrations
bunx drizzle-kit push

# Rollback (manual SQL file)
psql $POSTGRES_URL < drizzle/migrations/0001_down.sql
```

### Environment Variables
```bash
POSTGRES_URL=postgresql://user:password@localhost:5432/frutero_community
```

---

##  Definition of Done

- [ ] All 5 tables created with complete schema
- [ ] All indexes created for performance
- [ ] Foreign key constraints working correctly
- [ ] Migration tested on clean database
- [ ] Rollback migration tested successfully
- [ ] TypeScript types exported and working
- [ ] Schema documentation complete
- [ ] Code reviewed and approved
- [ ] No TypeScript compilation errors
- [ ] Integration tests passing

---

**Created**: 2024-12-05
**Last Updated**: 2024-12-05
**Estimated Completion**: Day 2 of Sprint 1
