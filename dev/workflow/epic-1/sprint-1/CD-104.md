# CD-104: Create Telegram Bot Command `/invite`

**Epic**: Community Directory
**Sprint**: 1
**Story Points**: 3
**Priority**: P1 (High)
**Status**: â¬œ Not Started
**Assignee**: Unassigned
**Dependencies**: CD-103

---

## ðŸ“‹ Description

Implement Telegram bot action for Community Managers to create and send member invitations through conversational interface.

**Key Goals**:
- Create `/invite` command action
- Implement role-based access control
- Generate invitation codes via InvitationService
- Display shareable invitation links
- Provide clear error messages

---

## ðŸŽ¯ Acceptance Criteria

- [ ] Only Community Managers can use `/invite` command
- [ ] Command triggers conversational flow
- [ ] Optional Telegram username collection
- [ ] Invitation code and link displayed clearly
- [ ] Expiration time shown (3 days from now)
- [ ] Action registered in plugin
- [ ] Error messages are helpful and actionable
- [ ] Command works in Telegram development bot

---

## ðŸ“ Technical Approach

### Data Access Strategy
- **ElizaOS Memory**: Conversation history during invitation creation
- **Drizzle/PostgreSQL**: Invitation creation via InvitationService

### Architecture Notes
**Action Pattern** (from ARCHITECTURE_RECOMMENDATION.md):
- Extends ElizaOS Action interface
- validate() checks Community Manager role
- handler() creates invitation and responds
- Uses InvitationService for database operations

**Role Validation**:
- Query community_members table for user role
- Only role='community_manager' can proceed
- Clear error message for non-managers

---

## âœ… Tasks

- [ ] Create `inviteAction.ts` in actions/ directory
- [ ] Implement validate() with role check
- [ ] Implement handler() with conversation flow
- [ ] Extract optional Telegram username from message
- [ ] Call InvitationService.createInvitation()
- [ ] Format invitation link: `https://t.me/frutero_bot?start={code}`
- [ ] Format response with code, link, expiration
- [ ] Add error handling for service failures
- [ ] Add conversation examples for training
- [ ] Register action in plugin actions array
- [ ] Test in Telegram development bot

---

## ðŸ“ Files to Create/Modify

- `src/plugins/communityDirectory/actions/invite.ts` - Main action
- `src/plugins/communityDirectory/utils/messageParser.ts` - Extract username
- `src/plugins/communityDirectory/__tests__/inviteAction.test.ts` - Unit tests
- `src/plugins/communityDirectory/index.ts` - Register action (modify)

---

## ðŸ§ª Testing Requirements

### Unit Tests
- [ ] Test validate() returns true for community_manager
- [ ] Test validate() returns false for other roles
- [ ] Test handler() creates invitation with service
- [ ] Test username extraction from message
- [ ] Test invitation link formatting
- [ ] Test error handling for service failures

### Integration Tests
- [ ] Test full flow in ElizaOS runtime
- [ ] Test role validation with database
- [ ] Test invitation creation end-to-end

### Manual Testing
```bash
# In Telegram development bot:
/invite
/invite @username
/invite alice
```

---

## ðŸ”— Related Documentation

- [EPIC_1_IMPLEMENTATION_PLAN.md](../../../docs/specs/EPIC_1_IMPLEMENTATION_PLAN.md) - Lines 384-537 (Story 1.4)
- [ARCHITECTURE_RECOMMENDATION.md](../../../docs/specs/ARCHITECTURE_RECOMMENDATION.md) - Lines 413-544 (Action Implementation Example)
- [ElizaOS Action Pattern](https://elizaos.github.io/eliza/docs/core/actions/)

---

## ðŸ“ Implementation Notes

### Action Implementation Example

```typescript
// actions/invite.ts
import type { Action, IAgentRuntime, Memory, State, HandlerCallback } from '@elizaos/core';
import { InvitationService } from '../services/InvitationService';

export const inviteAction: Action = {
  name: 'INVITE_MEMBER',
  similes: ['SEND_INVITATION', 'CREATE_INVITE', 'INVITE'],
  description: 'Create an invitation for a new community member',

  validate: async (runtime: IAgentRuntime, message: Memory, state?: State) => {
    const userId = message.userId;
    const result = await runtime.database.query(
      'SELECT role, status FROM community_members WHERE telegram_id = $1',
      [userId]
    );

    if (result.rows.length === 0) return false;
    const { role, status } = result.rows[0];
    return role === 'community_manager' && status === 'active';
  },

  handler: async (
    runtime: IAgentRuntime,
    message: Memory,
    state?: State,
    options?: any,
    callback?: HandlerCallback
  ) => {
    try {
      const invitationService = runtime.getService('invitation-service') as InvitationService;
      
      // Get manager member_id
      const managerResult = await runtime.database.query(
        'SELECT member_id FROM community_members WHERE telegram_id = $1',
        [message.userId]
      );
      const managerId = managerResult.rows[0].member_id;

      // Extract optional Telegram username
      const telegramUsername = extractTelegramUsername(message.content.text);

      // Create invitation
      const invitation = await invitationService.createInvitation(
        managerId,
        telegramUsername
      );

      // Format response
      const inviteLink = `https://t.me/frutero_bot?start=${invitation.invitation_code}`;
      const expiresAt = new Date(invitation.expires_at).toLocaleString();

      const responseText = `
ðŸŽ‰ Invitation created successfully!

**Invitation Code**: \`${invitation.invitation_code}\`
**Invite Link**: ${inviteLink}

This invitation expires on **${expiresAt}** (3 days from now).

Share this link with the person you'd like to invite to Frutero Club! ðŸ¥­
      `.trim();

      if (callback) {
        await callback({ text: responseText, actions: ['INVITE_MEMBER'] });
      }

      return {
        success: true,
        text: responseText,
        values: {
          invitation_code: invitation.invitation_code,
          invite_link: inviteLink,
        },
      };
    } catch (error) {
      return {
        success: false,
        text: 'Failed to create invitation. Please try again.',
        error: error instanceof Error ? error : new Error(String(error)),
      };
    }
  },

  examples: [
    [
      {
        user: '{{user1}}',
        content: { text: '/invite' },
      },
      {
        user: '{{agent}}',
        content: {
          text: 'I\'d be happy to create an invitation! Would you like to send it to a specific Telegram user, or generate a general invite link?',
          action: 'INVITE_MEMBER',
        },
      },
      {
        user: '{{user1}}',
        content: { text: 'Just a general link' },
      },
      {
        user: '{{agent}}',
        content: {
          text: 'ðŸŽ‰ Invitation created successfully!\n\n**Invitation Code**: `abc123def456`\n**Invite Link**: https://t.me/frutero_bot?start=abc123def456\n\nThis invitation expires in 3 days.',
          action: 'INVITE_MEMBER',
        },
      },
    ],
  ],
};

function extractTelegramUsername(text: string): string | undefined {
  const match = text.match(/@(\w+)/);
  return match ? match[1] : undefined;
}

export default inviteAction;
```

---

## âœ… Definition of Done

- [ ] Action implements validate and handler correctly
- [ ] Role-based access control working
- [ ] Invitation creation via service successful
- [ ] Invitation links formatted correctly
- [ ] Error handling provides clear messages
- [ ] Unit tests achieve >80% coverage
- [ ] Action registered in plugin
- [ ] Tested in Telegram bot successfully
- [ ] Code reviewed and approved
- [ ] No TypeScript compilation errors

---

**Created**: 2024-12-05
**Last Updated**: 2024-12-05
**Estimated Completion**: Day 4 of Sprint 1
