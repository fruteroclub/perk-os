# CD-201: Implement Registration Conversation State Machine

**Epic**: Community Directory
**Sprint**: 2
**Story Points**: 8
**Priority**: P0 (Blocker)
**Status**: â¬œ Not Started
**Assignee**: Unassigned
**Dependencies**: CD-103

---

## ðŸ“‹ Description

Build multi-step conversational registration flow with state machine for handling GitHub verification, profile collection, and member creation.

**Key Goals**:
- Implement registration state machine (7 states)
- Integrate GitHub verification service
- Calculate reputation from GitHub metrics
- Create member profile in database
- Handle errors gracefully with retry logic

---

## ðŸŽ¯ Acceptance Criteria

- [ ] Registration triggered by invitation code or `/register` command
- [ ] State machine handles: INVITE_VALIDATION â†’ PROFILE_COLLECTION â†’ GITHUB_REQUEST â†’ GITHUB_VERIFICATION â†’ REPUTATION_CALCULATION â†’ WALLET_REQUEST â†’ COMPLETION
- [ ] Each state validates input before transition
- [ ] GitHub verification required, wallet optional
- [ ] Reputation score calculated and stored
- [ ] Error messages guide user to resolution
- [ ] Conversation tone matches kukulcÃ¡n personality
- [ ] State persisted across messages in ElizaOS Memory

---

## ðŸ“ Technical Approach

### Data Access Strategy
- **ElizaOS Memory**: Conversation history, registration state tracking, user context
- **Drizzle/PostgreSQL**: Member profile creation, invitation acceptance

### Architecture Notes
**State Machine Pattern**:
- Store state in ElizaOS conversation state
- Each state has validate and execute logic
- Transition guards prevent invalid state changes
- Error states allow retry without restart

**Integration Points**:
- InvitationService for code validation
- GitHubVerificationService for profile verification
- ReputationService for score calculation
- MemberContextProvider for conversation enrichment

---

## âœ… Tasks

- [ ] Create `registerAction` with state machine
- [ ] Implement INVITE_VALIDATION state
- [ ] Implement PROFILE_COLLECTION state (name, role, organization, country)
- [ ] Implement GITHUB_REQUEST state
- [ ] Implement GITHUB_VERIFICATION state with service integration
- [ ] Implement REPUTATION_CALCULATION state
- [ ] Implement WALLET_REQUEST state (optional)
- [ ] Implement COMPLETION state with welcome message
- [ ] Add state transition logic with guards
- [ ] Add error handling and retry mechanisms
- [ ] Create member profile in database
- [ ] Accept invitation after completion
- [ ] Store relationship in ElizaOS Memory
- [ ] Add conversation examples for training
- [ ] Write unit tests for each state
- [ ] Write integration tests for full flow

---

## ðŸ“ Files to Create/Modify

- `src/plugins/communityDirectory/actions/register.ts` - Main action
- `src/plugins/communityDirectory/utils/registrationStateMachine.ts` - State machine logic
- `src/plugins/communityDirectory/__tests__/registration.test.ts` - Unit tests
- `src/plugins/communityDirectory/__tests__/e2e/registrationFlow.e2e.ts` - E2E tests
- `src/plugins/communityDirectory/index.ts` - Register action (modify)

---

## ðŸ§ª Testing Requirements

### Unit Tests
- [ ] Test each state transition
- [ ] Test invitation validation
- [ ] Test profile data collection
- [ ] Test GitHub verification (mocked)
- [ ] Test reputation calculation
- [ ] Test member creation
- [ ] Test error handling
- [ ] Test state persistence

### Integration Tests
- [ ] Test full registration flow end-to-end
- [ ] Test conversation state across multiple messages
- [ ] Test error recovery and retry
- [ ] Test invitation acceptance

---

## ðŸ”— Related Documentation

- [EPIC_1_IMPLEMENTATION_PLAN.md](../../../docs/specs/EPIC_1_IMPLEMENTATION_PLAN.md) - Lines 837-873 (Story 2.1)
- [ARCHITECTURE_RECOMMENDATION.md](../../../docs/specs/ARCHITECTURE_RECOMMENDATION.md) - Lines 413-544 (Action Implementation)
- [COMMUNITY_DIRECTORY_SPEC.md](../../../docs/COMMUNITY_DIRECTORY_SPEC.md) - Lines 216-427 (Registration Flow)

---

## ðŸ“ Implementation Notes

### State Machine Flow

```typescript
enum RegistrationState {
  START = 'START',
  INVITE_VALIDATION = 'INVITE_VALIDATION',
  PROFILE_COLLECTION = 'PROFILE_COLLECTION',
  GITHUB_REQUEST = 'GITHUB_REQUEST',
  GITHUB_VERIFICATION = 'GITHUB_VERIFICATION',
  REPUTATION_CALCULATION = 'REPUTATION_CALCULATION',
  WALLET_REQUEST = 'WALLET_REQUEST',
  COMPLETION = 'COMPLETION',
}

// State data stored in ElizaOS Memory
interface RegistrationData {
  invitationCode?: string;
  name?: string;
  role?: string;
  organization?: string;
  country?: string;
  githubUsername?: string;
  githubData?: any;
  reputationScore?: number;
  walletAddress?: string;
}
```

See EPIC_1_IMPLEMENTATION_PLAN.md lines 837-873 for detailed state machine implementation guidance.

---

## âœ… Definition of Done

- [ ] All 7 states implemented correctly
- [ ] State transitions work with guards
- [ ] GitHub verification integrated
- [ ] Reputation calculation working
- [ ] Member profile created successfully
- [ ] Invitation accepted after registration
- [ ] Error handling allows retry
- [ ] Unit tests achieve >80% coverage
- [ ] E2E tests pass
- [ ] Code reviewed and approved
- [ ] No TypeScript compilation errors

---

**Created**: 2024-12-05
**Last Updated**: 2024-12-05
**Estimated Completion**: Day 13 of Sprint 2
