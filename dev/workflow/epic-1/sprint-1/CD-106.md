# CD-106: Add Invitation Expiration Cron Job

**Epic**: Community Directory
**Sprint**: 1
**Story Points**: 2
**Priority**: P2 (Medium)
**Status**: ‚¨ú Not Started
**Assignee**: Unassigned
**Dependencies**: CD-103

---

## üìã Description

Create background service to automatically expire pending invitations that are past their expiration date.

**Key Goals**:
- Implement InvitationExpirationService as ElizaOS Service
- Run cron job every hour
- Update expired invitations to 'expired' status
- Add logging for monitoring

---

## üéØ Acceptance Criteria

- [ ] Service extends ElizaOS Service correctly
- [ ] Cron job runs every hour automatically
- [ ] Expired pending invitations updated to 'expired' status
- [ ] Logging shows number of invitations expired
- [ ] Service starts with plugin initialization
- [ ] No performance impact on other operations

---

## üìê Technical Approach

### Data Access Strategy
- **ElizaOS Memory**: NOT used for this ticket
- **Drizzle/PostgreSQL**: Bulk update query for expired invitations

### Architecture Notes
**Background Service Pattern**:
- Use setInterval for hourly execution
- Run immediately on startup, then every hour
- Use try-catch for error handling
- Log execution results for monitoring

**Query Optimization**:
- Single UPDATE query with WHERE clause
- Returns RETURNING clause for logging
- No individual invitation lookups

---

## ‚úÖ Tasks

- [ ] Create `InvitationExpirationService` class
- [ ] Implement initialize() with setInterval setup
- [ ] Implement expireInvitations() method
- [ ] Add UPDATE query with status and expiry conditions
- [ ] Add console logging for expired count
- [ ] Implement stop() method to clear interval
- [ ] Add error handling and logging
- [ ] Register service in plugin
- [ ] Test cron job execution
- [ ] Test expiration logic with test data

---

## üìÅ Files to Create/Modify

- `src/plugins/communityDirectory/services/InvitationExpirationService.ts` - Main service
- `src/plugins/communityDirectory/__tests__/invitationExpiration.test.ts` - Unit tests
- `src/plugins/communityDirectory/index.ts` - Register service (modify)

---

## üß™ Testing Requirements

### Unit Tests
- [ ] Test expireInvitations() updates expired invitations
- [ ] Test expireInvitations() does not update non-expired
- [ ] Test expireInvitations() does not update non-pending
- [ ] Test logging shows correct count

### Integration Tests
- [ ] Test service initializes and starts interval
- [ ] Test service runs immediately on startup
- [ ] Test service stops cleanly

---

## üîó Related Documentation

- [EPIC_1_IMPLEMENTATION_PLAN.md](../../../docs/specs/EPIC_1_IMPLEMENTATION_PLAN.md) - Lines 731-834 (Story 1.6)
- [ARCHITECTURE_RECOMMENDATION.md](../../../docs/specs/ARCHITECTURE_RECOMMENDATION.md) - Lines 338-411 (Service Pattern)

---

## üìù Implementation Notes

```typescript
// services/InvitationExpirationService.ts
import { Service, IAgentRuntime } from '@elizaos/core';
import { db } from '../database/client';
import { communityInvitations } from '../database/schema';
import { InvitationStatus } from '../types';
import { eq, and, lt } from 'drizzle-orm';

export class InvitationExpirationService extends Service {
  static serviceType = 'invitation-expiration-service';
  private intervalId?: NodeJS.Timeout;

  async initialize(runtime: IAgentRuntime): Promise<void> {
    // Run every hour (60 minutes)
    this.intervalId = setInterval(() => this.expireInvitations(), 60 * 60 * 1000);

    // Run immediately on startup
    await this.expireInvitations();
  }

  async expireInvitations(): Promise<void> {
    try {
      const expired = await db
        .update(communityInvitations)
        .set({ status: InvitationStatus.EXPIRED, updated_at: new Date() })
        .where(
          and(
            eq(communityInvitations.status, InvitationStatus.PENDING),
            lt(communityInvitations.expires_at, new Date())
          )
        )
        .returning({ invitation_id: communityInvitations.invitation_id });

      const count = expired.length;
      if (count > 0) {
        console.log(`[InvitationExpirationService] Expired ${count} invitations`);
      }
    } catch (error) {
      console.error('[InvitationExpirationService] Error expiring invitations:', error);
    }
  }

  async stop(): Promise<void> {
    if (this.intervalId) {
      clearInterval(this.intervalId);
    }
  }

  static async start(runtime: IAgentRuntime): Promise<InvitationExpirationService> {
    const service = new InvitationExpirationService(runtime);
    await service.initialize(runtime);
    return service;
  }
}
```

---

## ‚úÖ Definition of Done

- [ ] Service implements cron job correctly
- [ ] Expiration logic updates only expired pending invitations
- [ ] Logging provides monitoring visibility
- [ ] Service starts and stops cleanly
- [ ] Unit tests achieve >80% coverage
- [ ] Service registered in plugin
- [ ] Tested with expired test data
- [ ] Code reviewed and approved
- [ ] No TypeScript compilation errors

---

**Created**: 2024-12-05
**Last Updated**: 2024-12-05
**Estimated Completion**: Day 5 of Sprint 1
